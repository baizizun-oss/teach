<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0;" name="viewport" />
<title>编辑操作试题</title>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<style>
tr {
  height: auto;
  font-size: 16px;
}
th {
  text-align: right;
  padding-right: 10px;
  vertical-align: top;
}
td {
  padding: 8px;
}
input[type="text"], select, textarea {
  width: 100%;
  padding: 6px;
  font-size: 16px;
  box-sizing: border-box;
}
input[type="file"] {
  width: 100%;
}
input[type="submit"] {
  width: 100%;
  height: 60px;
  font-size: 20px;
  background: #4CAF50;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}
.scoring-item {
  display: flex;
  align-items: center;
  margin-bottom: 8px;
  gap: 10px;
  flex-wrap: wrap;
}
.scoring-item label {
  min-width: 120px;
  display: flex;
  align-items: center;
  gap: 5px;
}
.scoring-item input[type="number"] {
  width: 80px;
}
.scoring-item input[type="text"] {
  width: 200px;
}
</style>
</head>

<body>

<form action="edit?question_id={{question['question_id']}}&question_type=operation" method="post" enctype="multipart/form-data" name="add_form" target="_self">
  <table width="100%" border="1" style="border-collapse: collapse;">
    <tr>
      <th scope="row">题目</th>
      <td><input type="text" name="title" value="{{question['title']}}" required></td>
    </tr>
    <tr>
      <th scope="row">图片1</th>
      <td>
        <input type="file" name="photo1" class="photo">
        {% if question["picture"] != "" %}
          <br><img src="/static_operation_question_images/{{question['picture']}}" style="max-height:100px; max-width:200px;">
        {% end %}
      </td>
    </tr>
    <tr>
      <th scope="row">图片2</th>
      <td><input type="file" name="photo2" class="photo"></td>
    </tr>
    <tr>
      <th scope="row">图片3</th>
      <td><input type="file" name="photo3" class="photo"></td>
    </tr>
    <tr>
      <th scope="row">素材文件1</th>
      <td>
        <input type="file" name="material" class="file">
        {% if question["material"] != "" %}
          <br><a href="/static_operation_question_files/{{question['material']}}">{{question["material"]}}</a>
        {% end %}
      </td>
    </tr>    
    <tr>
      <th scope="row">素材文件2</th>
      <td>
        <input type="file" name="material2" class="file">
        {% if question["material2"] != "" %}
          <br><a href="/static_operation_question_files/{{question['material2']}}">{{question["material2"]}}</a>
        {% end %}
      </td>
    </tr>        
    <tr>
      <th>所属模块</th>
      <td>
        <select name="module" id="module" required>
          <option value="">请选择模块</option>
          {% for module in modules %}
            <option value="{{module['id']}}" {% if module['id'] == question['module_id'] %}selected{% end %}>
              {{module["name"]}}
            </option>
          {% end %}
        </select>
      </td>
    </tr>
    <tr>
      <th scope="row">知识点</th>
      <td>
        <select name="knowledge" id="knowledge" disabled>
          <option>请先选择模块</option>
          {% if question["knowledge_id"] %}
            <option value="{{question['knowledge_id']}}" selected>{{question["knowledge_name"]}}</option>
          {% end %}
        </select>
      </td>
    </tr>        
    <tr>
      <th scope="row">试题难度</th>
      <td>
        <select name="difficult">
          <option value="简单" {% if question['difficult'] == '简单' %}selected{% end %}>简单</option>
          <option value="困难" {% if question['difficult'] == '困难' %}selected{% end %}>困难</option>
        </select>
      </td>
    </tr>  

    <tr>
      <th scope="row">标准答案文件</th>
      <td>
        <input type="file" name="correct_answer" class="file">
        {% if question["correct_answer"] != "" %}
          <br><a href="/static_operation_question_files/{{question['correct_answer']}}">{{question["correct_answer"]}}</a>
        {% end %}
      </td>
    </tr>

    <!-- 新增：评分规则配置 -->
    <tr>
      <th scope="row">评分规则配置</th>
      <td>
        <!-- 解析当前评分规则（如果存在） -->
        {% set rules = question.get('score_rules_dict', {}) %}
        
        <div class="scoring-item">
          <label>
            <input type="checkbox" name="rule_enabled_cell_values" value="1"
              {% if rules.get('cell_values', {}).get('max_score', 0) > 0 %}checked{% end %}>
            单元格值比对
          </label>
          <input type="number" name="rule_score_cell_values" 
                value="{{ rules.get('cell_values', {}).get('max_score_str', '0') }}" 
                min="0" step="0.1"> 分
          <input type="text" name="rule_desc_cell_values" 
                 value="{{ rules.get('cell_values', {}).get('desc', '数据内容是否正确') }}">
        </div>

        <div class="scoring-item">
          <label>
            <input type="checkbox" name="rule_enabled_formulas" value="1"
              {% if rules.get('formulas', {}).get('max_score', 0) > 0 %}checked{% end %}>
            公式比对
          </label>

          <input type="number" name="rule_score_formulas" 
                value="{{ rules.get('formulas', {}).get('max_score_str', '0') }}" 
                min="0" step="0.1"> 分                 
          <input type="text" name="rule_desc_formulas" 
                 value="{{ rules.get('formulas', {}).get('desc', '是否使用公式计算') }}">
        </div>

        <div class="scoring-item">
          <label>
            <input type="checkbox" name="rule_enabled_chart" value="1"
              {% if rules.get('chart', {}).get('max_score', 0) > 0 %}checked{% end %}>
            图表
          </label>

          <input type="number" name="rule_score_chart" 
                value="{{ rules.get('chart', {}).get('max_score_str', '0') }}" 
                min="0" step="0.1"> 分                    
          <input type="text" name="rule_desc_chart" 
                 value="{{ rules.get('chart', {}).get('desc', '是否包含图表') }}">
        </div>

        <div class="scoring-item">
          <label>
            <input type="checkbox" name="rule_enabled_merged_cells" value="1"
              {% if rules.get('merged_cells', {}).get('max_score', 0) > 0 %}checked{% end %}>
            合并单元格
          </label>

          <input type="number" name="rule_score_merged_cells" 
                value="{{ rules.get('merged_cells', {}).get('max_score_str', '0') }}" 
                min="0" step="0.1"> 分                   
          <input type="text" name="rule_desc_merged_cells" 
                 value="{{ rules.get('merged_cells', {}).get('desc', '标题是否合并居中') }}">
        </div>

        <div class="scoring-item">
          <label>比对区域（可选）</label>
          <input type="text" name="compare_range" 
                 placeholder="如 A1:D20，留空则全表比对"
                 value="{{ rules.get('compare_range', '') }}">
        </div>
      </td>
    </tr>

    <tr>
      <th scope="row">&nbsp;</th>
      <td><input type="submit" value="更新试题"></td>
    </tr>
  </table>
</form>

<script>
$(document).ready(function() {
  $('#module').change(function() {
    const module = $(this).val();
    const $kpSelect = $('#knowledge');

    if (module) {
      $kpSelect.empty().prop('disabled', true).append('<option>加载中...</option>');
      $.get('/sangao/Question/get_module_knowledge', { module: module })
        .done(function(data) {
          $kpSelect.empty().prop('disabled', false);
          $kpSelect.append('<option value="12">暂未纳入</option>');
          data.forEach(item => {
            $kpSelect.append(`<option value="${item.id}">${item.name}</option>`);
          });
        })
        .fail(function() {
          $kpSelect.empty().prop('disabled', true).append('<option>加载失败</option>');
        });
    } else {
      $kpSelect.empty().prop('disabled', true).append('<option>请先选择模块</option>');
    }
  });

  // 初始化：如果已有模块，触发一次加载知识点（用于编辑时回显）
  if ($('#module').val()) {
    $('#module').trigger('change');
  }
});
</script>

</body>
</html>